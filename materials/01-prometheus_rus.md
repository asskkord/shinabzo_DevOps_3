# Prometheus

Prometheus — это набор инструментов для мониторинга и оповещения систем с открытым исходным кодом, изначально созданный в SoundCloud. С момента его создания в 2012 году многие компании и организации начали использовать Prometheus, а благодаря открытому исходному коду он находит высокую поддержку среди разработчиков. Prometheus содержит в себе базу метрик в виде базы данных временных рядов. 

Метрики — это числовые измерения. Временной ряд означает, что изменения записываются с течением времени. То, что пользователи хотят измерять, отличается от приложения к приложению. Для веб-сервера это может быть время запроса, для базы данных это может быть количество активных подключений или количество активных запросов и т. д.

Метрики играют важную роль в понимании того, почему приложение работает определенным образом. Предположим, вы запускаете веб-приложение и обнаруживаете, что оно работает медленно. Вам понадобится некоторая информация, чтобы узнать, что происходит с вашим приложением. Например, приложение может работать медленно, если количество запросов велико. Если у вас есть метрика количества запросов, вы можете определить причину и увеличить количество серверов для обработки нагрузки.

Обычно Prometheus состоит из нескольких основных компонентов:

- Prometheus Server - ядро системы;
- агенты сборки метрик или экспортеры (exporters);
- клиентские библиотеки для сборки метрик приложения (разделенные по языкам программирования);
- Alert Manager, управляющий отслеживанием критических событий в системе.

Prometheus Server агрегирует в себе все собираемые в системе метрики и предоставляет их через запросы в языке PromQL. Эти метрики могут быть как метриками внешними для приложения (их собирают экспортеры, например node_exporter), так и внутренними, собираемыми непосредственно в приложении при помощи клиентских библиотек.

**Основные экспортеры:**

1. Node exporter - для сборки метрик с машин или узлов кластера (nodes).

2. cAdvisor - для сборки метрик с docker-контейнеров

3. blackbox exporter - для сборки метрик доступности эндпоинтов по HTTP, HTTPS, DNS, TCP, ICMP и gRPC.

Сборка метрик приложений производится через специальную библиотеку, например, Micrometer для Java.

Всего Prometheus поддержвиает три типа метрик.

| Тип |	Предназначение | Пример |
|-------------|------------|----------|
| Gauge | Измерение использования ресурсов, мощности и т. д Значения, которые могут увеличиваться и уменьшаться, и которые имеют фиксированные верхние границы | Размер коллекции, количество запущенных потоков, колчиество сообщений в очереди, использование памяти |
| Counter | Измерение ряда событий или действий — величина, которая только увеличивается, а не уменьшается. | Общее количество обработанных заказов, общее количество выполненных задач и т. д. |
| Timer | Измерение кратковременных событий и их частоты | Время выполнения метода, время выполнения запроса |

У Prometheus имеется свой конфигурационный файл в формате yml. Простейший конфигурационный файл Prometheus может выглядеть следующим образом:

```yml
global:
  scrape_interval:     15s              # время, через которое Prometheus собирает метрики
  evaluation_interval: 15s              # время, через которое Prometheys высчитывает метрики
  scrape_timeout: 10s                   # время, по прошествию которого при попытке собрать метрику, она будет считаться не полученной

scrape_configs:
  - job_name: 'spring boot scrape'
    metrics_path: '/actuator/prometheus'
    scrape_interval: 5s
    static_configs:
      - targets: ['localhost:8080']     # хост, для считывания метрик
```

## PromQL

Язык запросов Prometheus - это PromQL (Prometheus Query Language). PromQL позволяет пользователю запросить и агрегировать временные ряды метрик, хранимых в базе данных Prometheus.

PromQL содердит множество операций, вот некоторые из них:

- Выборка (select) метрик: вы можете выбрать одну или несколько метрик для запроса. Пример: up{job="prometheus"}

- Агрегация (aggregation): вы можете агрегировать временные ряды метрик с помощью различных функций, таких как sum(), avg(), max(), min() и другие. Пример: sum(rate(http_requests_total{job="my-webapp"}[5m])) by (instance)

- Выполнение математических операций: вы можете выполнять математические операции с метриками, такие как сложение, вычитание, умножение и деление. Пример: rate(http_requests_total{job="my-webapp"}[5m]) / count(node_cpu_seconds_total{mode="idle"})

- Фильтрация (filtering): вы можете фильтровать метрики с помощью операторов сравнения, таких как =, !=, <, >, <=, >= и других. Пример: http_requests_total{status_code="500"}

- Группировка (grouping): вы можете группировать временные ряды метрик по определенным меткам (labels) с помощью ключевого слова by. Пример: sum(rate(http_requests_total{job="my-webapp"}[5m])) by (instance)
